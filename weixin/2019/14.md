# å¤šçº¿ç¨‹ç¼–ç¨‹å¸¸ç”¨å·¥å…·

ä¸Šç¯‡æ–‡ç« æˆ‘ä»¬ä»‹ç»äº†Pythonä¸­çš„å¤šçº¿ç¨‹ç¼–ç¨‹ï¼Œä¸»è¦ä»‹ç»äº†thredingæ¨¡å—çš„Threadç±»ã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬æ¥ä»‹ç»ä¸‹å¤šçº¿ç¨‹ç¼–ç¨‹ç»å¸¸ç”¨åˆ°çš„threadingæ¨¡å—çš„Lockã€RLockã€Conditionã€Eventã€Semaphoreã€Timerç±»å’ŒQueueæ¨¡å—ã€‚

#### Lock(é”)å’ŒRLock(å¯é‡å…¥é”)

åœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ï¼Œå¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶å¯¹ä¸€ä¸ªå˜é‡è¿›è¡Œä¿®æ”¹ï¼Œå°±è¦å¯¹è¿™ä¸ªçº¿ç¨‹åŠ é”ï¼Œå¦åˆ™å°±ä¼šå‡ºç°ä¿®æ”¹è¢«è¦†ç›–çš„é—®é¢˜ã€‚

çœ‹ä¸‹é¢çš„ç¨‹åºï¼Œå¼€äº†10ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹å¯¹sumåŠ 1000æ¬¡1ï¼Œæœ€åè¿è¡Œç»“æœå› è¯¥æ˜¯10000:

```python
import threading

sum = 0

def add():
    global sum
    for i in range(1000):
        sum += 1

def main():
    tasks = []
    for i in range(10):
        t = threading.Thread(target=add)
        t.start()
        tasks.append(t)
    for task in tasks:
        task.join()
    print sum

if __name__ == "__main__":
    main()
```

è¿è¡Œç»“æœï¼š
4653

è¿™æ˜¯å°±æ˜¯å› ä¸ºæ²¡æœ‰åŠ é”ï¼Œæˆ‘ä»¬åŠ ä¸Šé”çœ‹ä¸‹:

```python
import threading

sum = 0

lock = threading.Lock()

def add():
    global sum
    for i in range(1000):
        lock.acquire()
        sum += 1
        lock.release()

def main():
    tasks = []
    for i in range(10):
        t = threading.Thread(target=add)
        t.start()
        tasks.append(t)
    for task in tasks:
        task.join()
    print sum

if __name__ == "__main__":
    main()
```

è¿è¡Œç»“æœï¼š
10000

Lockå¯¹è±¡æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼Œacquireå’Œreleaseï¼Œè°ƒç”¨å®Œacquireåï¼Œåœ¨æ²¡æœ‰è°ƒç”¨releaseä¹‹å‰ï¼Œå¦‚æœå…¶ä»–çº¿ç¨‹è°ƒç”¨acquireå°±ä¼šé˜»å¡ï¼Œè¿™å°±ä¿è¯äº†åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯¹sumè¿›è¡Œæ“ä½œã€‚Lockä¹Ÿå®ç°äº†`__enter__`å’Œ`__exit__`æ–¹æ³•ï¼Œå¯ä»¥ä½¿ç”¨withæ“ä½œã€‚

*ä½¿ç”¨é”çš„è¿‡ç¨‹ä¸­è¦æ³¨æ„é¿å…æ­»é”ã€‚ä¾‹å¦‚ï¼šä¸¤ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½åœ¨ç­‰å¾…å¯¹æ–¹é‡Šæ”¾è‡ªå·±éœ€è¦çš„é”ï¼Œå°±ä¼šäº§ç”Ÿæ­»é”*

RLockå¯¹è±¡å’ŒLockç±»ä¼¼ï¼Œåªä¸è¿‡RLockå¯¹è±¡å¯ä»¥acquireå¤šæ¬¡ï¼Œreleaseçš„æ¬¡æ•°è¦å’Œacquireçš„æ¬¡æ•°ä¸€æ ·æ—¶é”æ‰ä¼šè¢«é‡Šæ”¾ã€‚

#### Semaphore(ä¿¡å·é‡)

Semaphoreå¯¹è±¡å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªè®¡æ•°å™¨ï¼Œæ¯è°ƒç”¨ä¸€æ¬¡acquireï¼Œè®¡æ•°å™¨çš„æ•°é‡å‡ä¸€ï¼Œæ¯è°ƒç”¨ä¸€æ¬¡releaseï¼Œè®¡æ•°å™¨çš„æ•°é‡åŠ ä¸€ï¼Œå¦‚æœè®¡æ•°å™¨çš„æ•°é‡ä¸º0ï¼Œåˆ™é˜»å¡çº¿ç¨‹ã€‚è®¡æ•°å™¨é»˜è®¤ä¸º1ã€‚Semaphoreå¯¹è±¡ä¹Ÿå¯ä»¥ä½¿ç”¨withæ“ä½œã€‚

å¦‚æœéœ€è¦æ§åˆ¶å¹¶å‘è¿è¡Œçš„çº¿ç¨‹æ•°ï¼Œä½¿ç”¨Semaphoreä¼šå¾ˆæ–¹ä¾¿ï¼š
```python
# coding: utf-8
import time
import threading
import random

def work(sema, i):
    with sema:
        print 'I am {} work.'.format(i)
        time.sleep(random.randint(1,3))
        print '{} work done.'.format(i)

def main():
    sema = threading.Semaphore(3)
    tasks = []
    for i in range(10):
        t = threading.Thread(target=work, args=(sema, i))
        t.start()
        tasks.append(t)

    for t in tasks:
        t.join()

if __name__ == '__main__':
    main()
```
è¿™æ ·ï¼ŒåŒä¸€æ—¶é—´åªä¼šæœ‰3ä¸ªçº¿ç¨‹åœ¨è¿è¡Œï¼Œå¦‚æœåšä¸€äº›å ç”¨èµ„æºæ¯”è¾ƒå¤§çš„å·¥ä½œï¼Œå¯ä»¥ä¿è¯ä¸ä¼šå‘ç”Ÿèµ„æºä¸è¶³çš„é—®é¢˜ã€‚

#### Condition

ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹å‘ç”Ÿå¿…è¦çš„æ¡ä»¶ååœ¨æ‰§è¡Œå¯ä»¥ä½¿ç”¨Conditionå¯¹è±¡ã€‚

Conditionå¯¹è±¡çš„ä¸»è¦æ–¹æ³•ï¼š

acquire/release: åŠ é”å’Œé‡Šæ”¾Â 
wait([timeout]): ç­‰å¾…ç›¸åº”çš„æ¡ä»¶å‘ç”Ÿï¼Œä¸ä¼ timeoutå‚æ•°åˆ™ä¸€ç›´ç­‰å¾…
notify: é€šçŸ¥ä¸€ä¸ªçº¿ç¨‹æ¡ä»¶å‘ç”Ÿäº†Â 
notifyAll: é€šçŸ¥æ‰€æœ‰çº¿ç¨‹æ¡ä»¶å‘ç”Ÿäº†

```python
# coding: utf-8
import time
import threading
import random

def sleep(cond):
    print u'æˆ‘è¦ç¡è§‰'
    with cond:
        print u'ç­‰æ–‡ç« å†™å®Œ...'
        cond.wait()
        print u'æˆ‘å¯ä»¥ç¡è§‰äº†'

def play(cond):
    print u'æˆ‘æƒ³ç©'
    with cond:
        print u'ç­‰æ–‡ç« å†™å®Œ...'
        cond.wait()
        print u'æˆ‘å¯ä»¥ç©äº†'

def write_article(cond):
    print u'å†™å®Œæ–‡ç« æ‰èƒ½åšå…¶ä»–äº‹æƒ…'
    with cond:
        time.sleep(2)
        print u'æ–‡ç« å†™å®Œäº†'
        cond.notifyAll()

def main():
    cond = threading.Condition()
    s = threading.Thread(target=sleep, args=(cond,))
    p = threading.Thread(target=play, args=(cond,))
    w = threading.Thread(target=write_article, args=(cond,))
    s.start()
    p.start()
    time.sleep(1)  # é˜²æ­¢condåœ¨waitå‰å°±notifyäº†
    w.start()
    s.join()
    p.join()
    w.join()

if __name__ == '__main__':
    main()
```

è¾“å‡ºï¼š
æˆ‘è¦ç¡è§‰
ç­‰æ–‡ç« å†™å®Œ...
æˆ‘æƒ³ç©
ç­‰æ–‡ç« å†™å®Œ...
å†™å®Œæ–‡ç« æ‰èƒ½åšå…¶ä»–äº‹æƒ…
æ–‡ç« å†™å®Œäº†
æˆ‘å¯ä»¥ç¡è§‰äº†
æˆ‘å¯ä»¥ç©äº†

*çœŸæ­£è¿è¡Œæ—¶çš„å¯èƒ½ç”±äºå¤šçº¿ç¨‹åŒæ—¶è¾“å‡ºï¼Œé¡ºåºä¼šæ¯”è¾ƒä¹±*

#### Event

Eventå¯¹è±¡å’ŒConditionå¯¹è±¡å·®ä¸å¤šï¼Œåªä¸è¿‡Eventåªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹é€šçŸ¥ï¼Œä¸€ä¸ªçº¿ç¨‹ç­‰å¾…ã€‚

```python
# coding: utf-8
import time
import threading
import random

def sleep(event):
    print u'æˆ‘è¦ç¡è§‰'
    print u'ç­‰æ–‡ç« å†™å®Œ...'
    event.wait()
    print u'æˆ‘å¯ä»¥ç¡è§‰äº†'

def write_article(event):
    print u'å†™å®Œæ–‡ç« æ‰èƒ½ç¡è§‰'
    time.sleep(2)
    print u'æ–‡ç« å†™å®Œäº†'
    event.set()

def main():
    event = threading.Event()
    s = threading.Thread(target=sleep, args=(event,))
    w = threading.Thread(target=write_article, args=(event,))
    s.start()
    w.start()
    s.join()
    w.join()

if __name__ == '__main__':
    main()
```

#### Timer

Timeræ—¶Threadçš„å­ç±»ï¼Œå¯ä»¥å®ç°éš”ä¸€æ®µæ—¶é—´è°ƒç”¨æŸä¸ªå‡½æ•°ã€‚

```python
# coding: utf-8
import threading
import time

def work():
    print u'å¼€å§‹ä¸Šç­äº†'

if __name__ == "__main__":
    print u'ä¸‹ç­äº†ï¼Œå›å®¶ä¼‘æ¯'
    timer = threading.Timer(3600 * 12, work)  # 996ğŸ™‚
    timer.start()
    timer.join()
```

#### Queue

Queueæ¨¡å—çš„Queueå¯¹è±¡æ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ—ï¼Œå…¶åº•å±‚ä½¿ç”¨çš„æ—¶collectionsæ¨¡å—çš„deque(ä¹‹å‰ä»‹ç»è¿‡)ï¼Œæ‰€ä»¥æ€§èƒ½ä¹Ÿæ˜¯éå¸¸é«˜çš„ã€‚

Queueå¯¹è±¡å†…éƒ¨ä¼šæœ‰ä¸€ä¸ªè®¡æ•°å™¨ï¼Œä¸»è¦çš„æ–¹æ³•æœ‰ï¼š
put()ï¼šå‘é˜Ÿåˆ—åŠ ä¸€ä¸ªå¯¹è±¡ï¼Œå†…éƒ¨è®¡æ•°å™¨åŠ ä¸€
get()ï¼šä»é˜Ÿåˆ—å–ä¸€ä¸ªå¯¹è±¡ï¼Œå¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œå°†ä¼šé˜»å¡
task_done()ï¼šå†…éƒ¨è®¡æ•°å™¨å‡ä¸€
join()ï¼šç­‰å¾…è®¡æ•°å™¨å‡ä¸º0ï¼Œåœ¨å‡ä¸º0å‰ä¼šé˜»å¡

```python
# coding: utf-8
import threading
import Queue
import time
import random

def work(q):
    num = q.get()
    time.sleep(random.random())
    print num*num
    q.task_done()

if __name__ == "__main__":
    q = Queue.Queue()
    for i in range(10):
        q.put(i)
    for i in range(10):
        w = threading.Thread(target=work, args=(q,))
        w.start()
    q.join()

```

Queueæ¨¡å—è¿˜æœ‰PriorityQueueå’ŒLifoQueueè¿™2ç§ç‰¹æ®Šé˜Ÿåˆ—ï¼Œè¿™é‡Œå°±ä¸è¯´äº†ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£äº†è§£ä¸‹ã€‚
