# CSRF 和 XSS

今天，我们来聊聊Web安全中常见的CSRF攻击和XSS攻击。

#### CSRF攻击

CSRF(Cross-site request forgery)攻击，中文名为跨站请求伪造。从名字就能看出，它是一种在一个网站上来向另一个网站发送伪造请求的一种攻击。

很多网站通过Cookie来对用户身份进行验证，用户登陆后，网站会生成一个Cookie，在Cookie失效之前，用户的所有请求都会带上这个Cookie。CSRF攻击其实就是利用了Cookie的这个特性，通过在攻击者的网站上构造一个向被攻击网站的请求来实现攻击。

CSRF攻击流程：

1、用户登陆A网站，A网站返回Cookie。

2、用户访问攻击者的网站B，B通过构造请求访问A网站。

3、攻击者B向A网站发起的请求会带上用户在A网站产生的Cookie，A网站会信任这个请求。

CSRF攻击示例：

A网站有一个转账的GET请求的HTTP的接口，必须要登陆才能访问，A网站在用户登陆之后会返回一个Cookie，请求的示例为：http://www.xxx.com/transfer?to_user=11&amont=100

当用户登陆A网站之后，在A网站Cookie还没有失效的情况下访问网站B，这个网站的HTML中会有一个<img src=http://www.xxx.com/transfer?to_user=22&amont=100>的标签，当用户访问B网站时，网站B会自动加载img标签中的url，然后浏览器发现是A网站的请求，就会带上A网站的Cookie，这样攻击者就实现了一个跨站请求伪造攻击。

当然，一般网站并不会使用GET请求去做转账操作，就算是使用POST请求，攻击者也可以通过iframe等一些方式来伪造一个POST请求来达到目的，这个就不多介绍了，感兴趣的话可以自行查找如何实现。

CSRF攻击防范：

防止攻击者利用CSRF攻击的方式有很多种：

1、在用户访问一个带有表单的页面的时候，可以在这个表单中增加一个隐藏的字段，如果用户发过来的请求没有这个字段或者这个字段的值不合法说明不是用户正常的请求。

2、现在很多网站使用前后端分离的技术，不会进行模板渲染，前端获取不到这个隐藏字段，这种情况可以在Cookie中增加这个字段，然后前端使用JS获取这个字段的值，然后将这个值增加请求header中的一个字段中来交给后端验证。

3、不使用Cookie来做验证，例如可以使用其Authorization这个header来做用户验证，验证信息可以存储在浏览器的session storage或local storage中，这样浏览器就不会自动带上，第三方网站也无法读取到。

Django框架对于CSRF的防范：

Django框架本身就内置了一个防止CSRF攻击的机制，是通过django.middleware.csrf.CsrfViewMiddleware这个默认的中间件实现的。Django既可以通过上边介绍的通过在表单验证中增加隐藏字段的方式来防止CSRF攻击，也可以在前后端分离的网站上通过Cookie和增加header字段的方式来防止CSRF攻击。


#### XSS攻击

XSS(Cross Site Scripting)攻击，中文名跨站脚本攻击，是一个通过向网站提交恶意脚本的方式来实现的攻击。

有些网站可以让用户输入内容提交保存之后向用户展示，但是如果网站不对用户提交的内容做验证和转换，用户就可以通过输入恶意脚本来窃取网站的一些数据。

XSS攻击流程：

1、攻击者利用网站提供的表单输入恶意脚本，网站没有对用户输入内容做验证和处理，并存储下来。

2、网站用户浏览到攻击者输入的带有恶意脚本的内容，会执行攻击者存放的恶意脚本。

XSS攻击示例：

网站A有一个表单可以让用户输入数据，攻击者输入一个脚本：`<script>alert(“hey!you are attacked”)</script>`提交，网站直接存储用户输入的内容。当有正常用户访问的时候，网站将攻击者输入的脚本渲染到页面上并返回，就会执行攻击者输入的脚本，比如：`<div id="content"><script>alert("hey!you are attacked"）</script></div>`，就可以在用户的浏览器中执行攻击者的代码。

当然，上边的脚本只是演示攻击的流程，并没有做什么恶意的事情，但是真正的攻击者可不会使用这么简单的脚本，通常他们会获取用户的部分Cookie(有些Cookie无法通过JS获取到)并发送到攻击者自己的服务器上，也可以通过JS来进行恶意跳转以达到流量劫持的目的。

XSS攻击看起来很容易防范，但是要注意攻击者可能通过一些手段来绕过这些防范，具体如何防范和绕过可以参考这篇文章：https://zhuanlan.zhihu.com/p/26177815

今天就介绍这么多，平时我们做Web开发基本不用担心这些攻击，因为很多框架都内置了一些防范这些攻击的代码来自动帮我们来阻止这些攻击。
